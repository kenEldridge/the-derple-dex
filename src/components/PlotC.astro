---
// Panel C: Interaction density
---

<div id="plot-c"></div>

<script>
	import Plotly from 'plotly.js-dist-min';

	function roughness(deltaF, cbw = 100) {
		const x = deltaF / cbw;
		return Math.exp(-3.5 * x) - Math.exp(-5.75 * x);
	}

	function gaussianKDE(data, points, bandwidth) {
		const n = data.length;
		const result = new Array(points.length).fill(0);

		for (let i = 0; i < points.length; i++) {
			for (let j = 0; j < n; j++) {
				const diff = (points[i] - data[j]) / bandwidth;
				result[i] += Math.exp(-0.5 * diff * diff);
			}
			result[i] /= (n * bandwidth * Math.sqrt(2 * Math.PI));
		}

		return result;
	}

	const f0 = 200.0;
	const numPartials = 30;
	const partials = Array.from({length: numPartials}, (_, i) => i + 1);

	const intervals = [
		{name: 'Major third (5:4)', ratio: 5/4, color: '#ff6b6b'},
		{name: 'Perfect fourth (4:3)', ratio: 4/3, color: '#ffb74d'},
		{name: 'Perfect fifth (3:2)', ratio: 3/2, color: '#81c784'},
		{name: 'Octave (2:1)', ratio: 2.0, color: '#64b5f6'}
	];

	const xRangeC = Array.from({length: 600}, (_, i) => i * (200 / 599));
	const rCurve = xRangeC.map(x => roughness(x));
	const rCurveMax = Math.max(...rCurve);

	const tracesC = [];
	let yMax = 0;
	const fA = partials.map(p => p * f0);

	for (const interval of intervals.reverse()) {
		const fB = partials.map(p => p * f0 * interval.ratio);
		const deltaVals = [];

		for (let i = 0; i < fA.length; i++) {
			for (let j = 0; j < fB.length; j++) {
				const delta = Math.abs(fA[i] - fB[j]);
				if (delta <= 200) {
					deltaVals.push(delta);
				}
			}
		}

		const y = gaussianKDE(deltaVals, xRangeC, 3.5);
		const yScaled = y.map(val => val * deltaVals.length);
		yMax = Math.max(yMax, ...yScaled);

		tracesC.push({
			x: xRangeC,
			y: yScaled,
			type: 'scatter',
			mode: 'lines',
			line: {color: interval.color, width: 2},
			name: interval.name
		});

		const deltaFFund = Math.abs(f0 - interval.ratio * f0);
		tracesC.push({
			x: [deltaFFund, deltaFFund],
			y: [0, yMax],
			type: 'scatter',
			mode: 'lines',
			line: {color: interval.color, width: 1, dash: 'dot'},
			opacity: 0.5,
			showlegend: false,
			hoverinfo: 'skip'
		});
	}

	const rCurveScaled = rCurve.map(val => (val / rCurveMax) * yMax);
	tracesC.push({
		x: xRangeC,
		y: rCurveScaled,
		type: 'scatter',
		mode: 'lines',
		line: {color: 'white', width: 2, dash: 'dash'},
		name: 'Ear roughness sensitivity',
		opacity: 0.8
	});

	const layoutC = {
		xaxis: {title: 'Frequency difference Î”f (Hz, within one octave)', gridcolor: 'rgba(255,255,255,0.2)'},
		yaxis: {title: 'Interaction density', gridcolor: 'rgba(255,255,255,0.2)'},
		paper_bgcolor: '#000000',
		plot_bgcolor: '#000000',
		font: {color: 'white'},
		legend: {
			orientation: 'h',
			x: 0.5,
			xanchor: 'center',
			y: -0.2,
			yanchor: 'top',
			bgcolor: 'rgba(26,26,26,0.9)',
			bordercolor: 'white',
			borderwidth: 1
		},
		margin: {l: 60, r: 20, t: 20, b: 100}
	};

	const config = {responsive: true};
	Plotly.newPlot('plot-c', tracesC, layoutC, config);
</script>

<style>
	#plot-c {
		width: 100%;
		height: 400px;
		margin: 1.5rem 0;
	}
</style>
